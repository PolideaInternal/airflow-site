:mod:`airflow.gcp.operators.dataflow`
=====================================

.. py:module:: airflow.gcp.operators.dataflow

.. autoapi-nested-parse::

   This module contains Google Dataflow operators.



Module Contents
---------------

.. py:class:: CheckJobRunning

   Bases: :class:`enum.Enum`

   Helper enum for choosing what to do if job is already running
   IgnoreJob - do not check if running
   FinishIfRunning - finish current dag run with no action
   WaitForRun - wait for job to finish and then continue with new job

   .. attribute:: IgnoreJob
      :annotation: = 1

      

   .. attribute:: FinishIfRunning
      :annotation: = 2

      

   .. attribute:: WaitForRun
      :annotation: = 3

      


.. py:class:: DataFlowJavaOperator(jar:str, job_name:str='{{task.task_id}}', dataflow_default_options:Optional[dict]=None, options:Optional[dict]=None, gcp_conn_id:str='google_cloud_default', delegate_to:Optional[str]=None, poll_sleep:int=10, job_class:Optional[str]=None, check_if_running:CheckJobRunning=CheckJobRunning.WaitForRun, multiple_jobs:Optional[bool]=None, *args, **kwargs)

   Bases: :class:`airflow.models.BaseOperator`

   Start a Java Cloud DataFlow batch job. The parameters of the operation
   will be passed to the job.

   **Example**: ::

       default_args = {
           'owner': 'Airflow',
           'depends_on_past': False,
           'start_date':
               (2016, 8, 1),
           'email': ['alex@vanboxel.be'],
           'email_on_failure': False,
           'email_on_retry': False,
           'retries': 1,
           'retry_delay': timedelta(minutes=30),
           'dataflow_default_options': {
               'project': 'my-gcp-project',
               'zone': 'us-central1-f',
               'stagingLocation': 'gs://bucket/tmp/dataflow/staging/',
           }
       }

       dag = DAG('test-dag', default_args=default_args)

       task = DataFlowJavaOperator(
           gcp_conn_id='gcp_default',
           task_id='normalize-cal',
           jar='{{var.value.gcp_dataflow_base}}pipeline-ingress-cal-normalize-1.0.jar',
           options={
               'autoscalingAlgorithm': 'BASIC',
               'maxNumWorkers': '50',
               'start': '{{ds}}',
               'partitionType': 'DAY'

           },
           dag=dag)

   .. seealso::
       For more detail on job submission have a look at the reference:
       https://cloud.google.com/dataflow/pipelines/specifying-exec-params

   :param jar: The reference to a self executing DataFlow jar (templated).
   :type jar: str
   :param job_name: The 'jobName' to use when executing the DataFlow job
       (templated). This ends up being set in the pipeline options, so any entry
       with key ``'jobName'`` in ``options`` will be overwritten.
   :type job_name: str
   :param dataflow_default_options: Map of default job options.
   :type dataflow_default_options: dict
   :param options: Map of job specific options.
   :type options: dict
   :param gcp_conn_id: The connection ID to use connecting to Google Cloud
       Platform.
   :type gcp_conn_id: str
   :param delegate_to: The account to impersonate, if any.
       For this to work, the service account making the request must have
       domain-wide delegation enabled.
   :type delegate_to: str
   :param poll_sleep: The time in seconds to sleep between polling Google
       Cloud Platform for the dataflow job status while the job is in the
       JOB_STATE_RUNNING state.
   :type poll_sleep: int
   :param job_class: The name of the dataflow job class to be executed, it
       is often not the main class configured in the dataflow jar file.
   :type job_class: str

   :param multiple_jobs: If pipeline creates multiple jobs then monitor all jobs
   :type multiple_jobs: boolean
   :param check_if_running: before running job, validate that a previous run is not in process
   :type check_if_running: CheckJobRunning(IgnoreJob = do not check if running, FinishIfRunning=
       if job is running finish with nothing, WaitForRun= wait until job finished and the run job)
       ``jar``, ``options``, and ``job_name`` are templated so you can use variables in them.

   Note that both
   ``dataflow_default_options`` and ``options`` will be merged to specify pipeline
   execution parameter, and ``dataflow_default_options`` is expected to save
   high-level options, for instances, project and zone information, which
   apply to all dataflow operators in the DAG.

   It's a good practice to define dataflow_* parameters in the default_args of the dag
   like the project, zone and staging location.

   .. code-block:: python

      default_args = {
          'dataflow_default_options': {
              'project': 'my-gcp-project',
              'zone': 'europe-west1-d',
              'stagingLocation': 'gs://my-staging-bucket/staging/'
          }
      }

   You need to pass the path to your dataflow as a file reference with the ``jar``
   parameter, the jar needs to be a self executing jar (see documentation here:
   https://beam.apache.org/documentation/runners/dataflow/#self-executing-jar).
   Use ``options`` to pass on options to your job.

   .. code-block:: python

      t1 = DataFlowJavaOperator(
          task_id='datapflow_example',
          jar='{{var.value.gcp_dataflow_base}}pipeline/build/libs/pipeline-example-1.0.jar',
          options={
              'autoscalingAlgorithm': 'BASIC',
              'maxNumWorkers': '50',
              'start': '{{ds}}',
              'partitionType': 'DAY',
              'labels': {'foo' : 'bar'}
          },
          gcp_conn_id='airflow-conn-id',
          dag=my-dag)

   .. attribute:: template_fields
      :annotation: = ['options', 'jar', 'job_name']

      

   .. attribute:: ui_color
      :annotation: = #0273d4

      

   
   .. method:: execute(self, context)




.. py:class:: DataflowTemplateOperator(template:str, job_name:str='{{task.task_id}}', dataflow_default_options:Optional[dict]=None, parameters:Optional[dict]=None, gcp_conn_id:str='google_cloud_default', delegate_to:Optional[str]=None, poll_sleep:int=10, *args, **kwargs)

   Bases: :class:`airflow.models.BaseOperator`

   Start a Templated Cloud DataFlow batch job. The parameters of the operation
   will be passed to the job.

   :param template: The reference to the DataFlow template.
   :type template: str
   :param job_name: The 'jobName' to use when executing the DataFlow template
       (templated).
   :param dataflow_default_options: Map of default job environment options.
   :type dataflow_default_options: dict
   :param parameters: Map of job specific parameters for the template.
   :type parameters: dict
   :param gcp_conn_id: The connection ID to use connecting to Google Cloud
       Platform.
   :type gcp_conn_id: str
   :param delegate_to: The account to impersonate, if any.
       For this to work, the service account making the request must have
       domain-wide delegation enabled.
   :type delegate_to: str
   :param poll_sleep: The time in seconds to sleep between polling Google
       Cloud Platform for the dataflow job status while the job is in the
       JOB_STATE_RUNNING state.
   :type poll_sleep: int

   It's a good practice to define dataflow_* parameters in the default_args of the dag
   like the project, zone and staging location.

   .. seealso::
       https://cloud.google.com/dataflow/docs/reference/rest/v1b3/LaunchTemplateParameters
       https://cloud.google.com/dataflow/docs/reference/rest/v1b3/RuntimeEnvironment

   .. code-block:: python

      default_args = {
          'dataflow_default_options': {
              'project': 'my-gcp-project',
              'region': 'europe-west1',
              'zone': 'europe-west1-d',
              'tempLocation': 'gs://my-staging-bucket/staging/',
              }
          }
      }

   You need to pass the path to your dataflow template as a file reference with the
   ``template`` parameter. Use ``parameters`` to pass on parameters to your job.
   Use ``environment`` to pass on runtime environment variables to your job.

   .. code-block:: python

      t1 = DataflowTemplateOperator(
          task_id='datapflow_example',
          template='{{var.value.gcp_dataflow_base}}',
          parameters={
              'inputFile': "gs://bucket/input/my_input.txt",
              'outputFile': "gs://bucket/output/my_output.txt"
          },
          gcp_conn_id='airflow-conn-id',
          dag=my-dag)

   ``template``, ``dataflow_default_options``, ``parameters``, and ``job_name`` are
   templated so you can use variables in them.

   Note that ``dataflow_default_options`` is expected to save high-level options
   for project information, which apply to all dataflow operators in the DAG.

       .. seealso::
           https://cloud.google.com/dataflow/docs/reference/rest/v1b3
           /LaunchTemplateParameters
           https://cloud.google.com/dataflow/docs/reference/rest/v1b3/RuntimeEnvironment
           For more detail on job template execution have a look at the reference:
           https://cloud.google.com/dataflow/docs/templates/executing-templates

   .. attribute:: template_fields
      :annotation: = ['parameters', 'dataflow_default_options', 'template', 'job_name']

      

   .. attribute:: ui_color
      :annotation: = #0273d4

      

   
   .. method:: execute(self, context)




.. py:class:: DataFlowPythonOperator(py_file:str, job_name:str='{{task.task_id}}', py_options:Optional[List[str]]=None, dataflow_default_options:Optional[dict]=None, options:Optional[dict]=None, py_interpreter:str='python2', gcp_conn_id:str='google_cloud_default', delegate_to:Optional[str]=None, poll_sleep:int=10, *args, **kwargs)

   Bases: :class:`airflow.models.BaseOperator`

   Launching Cloud Dataflow jobs written in python. Note that both
   dataflow_default_options and options will be merged to specify pipeline
   execution parameter, and dataflow_default_options is expected to save
   high-level options, for instances, project and zone information, which
   apply to all dataflow operators in the DAG.

   .. seealso::
       For more detail on job submission have a look at the reference:
       https://cloud.google.com/dataflow/pipelines/specifying-exec-params

   :param py_file: Reference to the python dataflow pipeline file.py, e.g.,
       /some/local/file/path/to/your/python/pipeline/file. (templated)
   :type py_file: str
   :param job_name: The 'job_name' to use when executing the DataFlow job
       (templated). This ends up being set in the pipeline options, so any entry
       with key ``'jobName'`` or ``'job_name'`` in ``options`` will be overwritten.
   :type job_name: str
   :param py_options: Additional python options, e.g., ["-m", "-v"].
   :type py_options: list[str]
   :param dataflow_default_options: Map of default job options.
   :type dataflow_default_options: dict
   :param options: Map of job specific options.
   :type options: dict
   :param py_interpreter: Python version of the beam pipeline.
       If None, this defaults to the python2.
       To track python versions supported by beam and related
       issues check: https://issues.apache.org/jira/browse/BEAM-1251
   :type py_interpreter: str
   :param gcp_conn_id: The connection ID to use connecting to Google Cloud
       Platform.
   :type gcp_conn_id: str
   :param delegate_to: The account to impersonate, if any.
       For this to work, the service account making the request must have
       domain-wide  delegation enabled.
   :type delegate_to: str
   :param poll_sleep: The time in seconds to sleep between polling Google
       Cloud Platform for the dataflow job status while the job is in the
       JOB_STATE_RUNNING state.
   :type poll_sleep: int

   .. attribute:: template_fields
      :annotation: = ['options', 'dataflow_default_options', 'job_name', 'py_file']

      

   
   .. method:: execute(self, context)

      Execute the python dataflow job.




.. py:class:: GoogleCloudBucketHelper(gcp_conn_id:str='google_cloud_default', delegate_to:Optional[str]=None)

   GoogleCloudStorageHook helper class to download GCS object.

   .. attribute:: GCS_PREFIX_LENGTH
      :annotation: = 5

      

   
   .. method:: google_cloud_to_local(self, file_name:str)

      Checks whether the file specified by file_name is stored in Google Cloud
      Storage (GCS), if so, downloads the file and saves it locally. The full
      path of the saved file will be returned. Otherwise the local file_name
      will be returned immediately.

      :param file_name: The full path of input file.
      :type file_name: str
      :return: The full path of local file.
      :rtype: str




